<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF拆分与缩略图展示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="shortcut icon" href="logo.svg" type="image/x-icon"/>

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#6B7280',
                        accent: '#10B981',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>


</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- 标题区域 -->
    <header class="mb-8 text-center">
        <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-800 mb-2">
            PDF拆分与缩略图展示
        </h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            上传PDF文件，将其拆分为图片并生成缩略图，支持下载单个页面或全部页面
        </p>
    </header>

    <!-- 上传区域 -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 transition-all duration-300 hover:shadow-lg">
        <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors duration-300">
            <i class="fa fa-file-pdf-o text-5xl text-red-500 mb-4"></i>
            <h3 class="text-lg font-semibold mb-2">拖放PDF文件到此处或点击上传</h3>
            <p class="text-gray-500 mb-4">支持所有PDF格式文件</p>
            <label class="inline-block bg-primary text-white px-6 py-3 rounded-lg font-medium cursor-pointer hover:bg-primary/90 transition-colors duration-300"
                   onclick="event.stopPropagation()">
                <i class="fa fa-upload mr-2"></i>选择PDF文件
                <input type="file" id="file-input" accept=".pdf" class="hidden">
            </label>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-gray-600">正在处理PDF文件，请稍候...</p>
        </div>
    </div>

    <!-- 信息和控制区域 -->
    <div id="pdf-info" class="hidden mb-6">
        <div class="flex flex-wrap justify-between items-center gap-4">
            <div>
                <h2 id="pdf-title" class="text-xl font-bold text-gray-800"></h2>
                <p id="pdf-page-count" class="text-gray-600"></p>
            </div>
            <div class="flex gap-3">
                <button id="download-all" class="bg-accent text-white px-4 py-2 rounded-lg font-medium hover:bg-accent/90 transition-colors duration-300 flex items-center">
                    <i class="fa fa-download mr-2"></i>下载全部页面
                </button>
                <button id="clear-all" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition-colors duration-300 flex items-center">
                    <i class="fa fa-trash mr-2"></i>清除
                </button>
            </div>
        </div>
    </div>

    <!-- 缩略图展示区域 -->
    <div id="thumbnails-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-12">
        <!-- 缩略图将在这里动态生成 -->
    </div>

    <!-- 分页控制 -->
    <div id="pagination" class="hidden flex justify-center items-center gap-2 mt-6">
        <button id="prev-page" class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fa fa-chevron-left"></i>
        </button>
        <span id="page-info" class="text-gray-600"></span>
        <button id="next-page" class="px-4 py-2 border rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fa fa-chevron-right"></i>
        </button>
    </div>

    <!-- 预览模态框 -->
    <div id="preview-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl w-full max-h-[90vh] p-4">
            <button id="close-modal" class="absolute -top-12 right-0 text-white text-2xl hover:text-gray-300">
                <i class="fa fa-times"></i>
            </button>
            <img id="preview-image" src="" alt="PDF页面预览" class="max-w-full max-h-[90vh] object-contain">
            <button id="download-current" class="absolute bottom-4 right-4 bg-white/90 text-dark px-4 py-2 rounded-lg font-medium hover:bg-white transition-colors duration-300 flex items-center">
                <i class="fa fa-download mr-2"></i>下载此页
            </button>
        </div>
    </div>
</div>

<script>
    // 配置PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // 全局变量
    let pdfDoc = null;
    let totalPages = 0;
    let currentPage = 1;
    let allImages = []; // 存储所有页面的图片数据
    const THUMBS_PER_PAGE = 12; // 每页显示的缩略图数量

    // DOM元素
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const loading = document.getElementById('loading');
    const pdfInfo = document.getElementById('pdf-info');
    const pdfTitle = document.getElementById('pdf-title');
    const pdfPageCount = document.getElementById('pdf-page-count');
    const thumbnailsContainer = document.getElementById('thumbnails-container');
    const downloadAllBtn = document.getElementById('download-all');
    const clearAllBtn = document.getElementById('clear-all');
    const pagination = document.getElementById('pagination');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');
    const previewModal = document.getElementById('preview-modal');
    const previewImage = document.getElementById('preview-image');
    const closeModalBtn = document.getElementById('close-modal');
    const downloadCurrentBtn = document.getElementById('download-current');
    let currentPreviewImage = ''; // 当前预览的图片

    // 事件监听
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    // 拖放事件
    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('border-primary');
    });

    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('border-primary');
    });

    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('border-primary');

        if (e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    // 分页控制
    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderThumbnails();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        if (currentPage < getTotalPages()) {
            currentPage++;
            renderThumbnails();
        }
    });

    // 清除按钮
    clearAllBtn.addEventListener('click', clearAll);

    // 下载全部
    downloadAllBtn.addEventListener('click', downloadAllPages);

    // 模态框控制
    closeModalBtn.addEventListener('click', () => {
        previewModal.classList.add('hidden');
    });

    previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) {
            previewModal.classList.add('hidden');
        }
    });

    // 下载当前预览页
    downloadCurrentBtn.addEventListener('click', () => {
        if (currentPreviewImage) {
            downloadImage(currentPreviewImage, `page-${currentPreviewImage.pageNumber}.jpg`);
        }
    });

    // 处理文件选择
    function handleFileSelect(e) {
        if (e.target.files.length) {
            handleFile(e.target.files[0]);
        }
    }

    // 处理PDF文件
    async function handleFile(file) {
        // 验证文件类型
        if (file.type !== 'application/pdf') {
            alert('请上传PDF格式的文件');
            return;
        }

        // 显示加载状态
        loading.classList.remove('hidden');
        dropArea.classList.add('hidden');
        clearAll(); // 清除之前的内容

        try {
            // 读取PDF文件
            const fileData = await readFileAsync(file);
            const typedArray = new Uint8Array(fileData);

            // 加载PDF
            pdfDoc = await pdfjsLib.getDocument(typedArray).promise;
            totalPages = pdfDoc.numPages;
            allImages = [];

            // 更新信息
            pdfTitle.textContent = file.name;
            pdfPageCount.textContent = `共 ${totalPages} 页`;
            pdfInfo.classList.remove('hidden');

            // 渲染所有页面为图片
            await renderAllPages();

            // 显示缩略图
            renderThumbnails();
            pagination.classList.remove('hidden');

        } catch (error) {
            console.error('处理PDF时出错:', error);
            alert('处理PDF文件时出错，请尝试其他文件');
        } finally {
            loading.classList.add('hidden');
        }
    }

    // 读取文件
    function readFileAsync(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    async function renderAllPages() {
        allImages = []; // 清空旧数据

        for (let i = 1; i <= totalPages; i++) {
            try {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                if (!context) {
                    throw new Error('无法获取Canvas上下文');
                }

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // 生成图片数据（添加错误处理）
                let imageData;
                try {
                    imageData = canvas.toDataURL('image/jpeg', 0.9);
                } catch (e) {
                    console.warn('JPEG生成失败，尝试PNG:', e);
                    imageData = canvas.toDataURL('image/png');
                }

                // 确保生成的是有效字符串
                if (typeof imageData !== 'string' || !imageData.startsWith('data:image/')) {
                    throw new Error('生成的图片数据无效');
                }

                allImages.push({
                    data: imageData,
                    pageNumber: i,
                    blob: dataURLtoBlob(imageData) // 新增blob格式备份
                });

            } catch (error) {
                console.error(`处理第 ${i} 页时出错:`, error);
                // 跳过错误页或使用占位图
                allImages.push({
                    data: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2NjYiPkVycm9yPC90ZXh0Pjwvc3ZnPg==',
                    pageNumber: i,
                    error: true
                });
            }
        }
    }

    // 新增工具函数：dataURL转Blob
    function dataURLtoBlob(dataURL) {
        const parts = dataURL.split(',');
        const mime = parts[0].match(/:(.*?);/)[1];
        const bstr = atob(parts[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);

        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }

        return new Blob([u8arr], { type: mime });
    }
    // 渲染缩略图
    function renderThumbnails() {
        thumbnailsContainer.innerHTML = '';

        // 计算当前页显示的缩略图范围
        const startIndex = (currentPage - 1) * THUMBS_PER_PAGE;
        const endIndex = Math.min(startIndex + THUMBS_PER_PAGE, allImages.length);
        const currentThumbs = allImages.slice(startIndex, endIndex);

        // 创建缩略图元素
        currentThumbs.forEach(thumb => {
            const thumbnailDiv = document.createElement('div');
            thumbnailDiv.className = 'bg-white rounded-lg shadow p-2 pdf-thumbnail-hover fade-in';
            thumbnailDiv.innerHTML = `
                    <div class="relative pb-[141%] overflow-hidden rounded">
                        <img src="${thumb.data}" alt="第 ${thumb.pageNumber} 页"
                             class="absolute top-0 left-0 w-full h-full object-contain">
                        <div class="absolute top-1 right-1 bg-primary/80 text-white text-xs px-1.5 rounded">
                            ${thumb.pageNumber}
                        </div>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-sm text-gray-600">第 ${thumb.pageNumber} 页</span>
                        <button class="text-gray-500 hover:text-primary download-thumb"
                                data-image="${thumb.data}" data-page="${thumb.pageNumber}">
                            <i class="fa fa-download"></i>
                        </button>
                    </div>
                `;

            // 添加点击事件（预览）
            thumbnailDiv.addEventListener('click', (e) => {
                // 如果点击的是下载按钮，则不打开预览
                if (!e.target.closest('.download-thumb')) {
                    openPreview(thumb.data, thumb.pageNumber);
                }
            });

            // 添加下载按钮事件
            const downloadBtn = thumbnailDiv.querySelector('.download-thumb');
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // 优先尝试使用blob格式
                if (thumb.blob) {
                    downloadBlob(thumb.blob, `page-${thumb.pageNumber}.jpg`);
                } else {
                    downloadImage(thumb.data, `page-${thumb.pageNumber}.jpg`);
                }
            });

            thumbnailsContainer.appendChild(thumbnailDiv);
        });

        // 更新分页信息
        updatePagination();
    }

    // 更新分页信息
    function updatePagination() {
        const totalPages = getTotalPages();
        pageInfo.textContent = `第 ${currentPage} / ${totalPages} 页`;

        // 禁用/启用分页按钮
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
    }

    // 获取总页数
    function getTotalPages() {
        return Math.ceil(allImages.length / THUMBS_PER_PAGE);
    }

    // 打开预览
    function openPreview(imageData, pageNumber) {
        currentPreviewImage = {
            data: imageData,
            pageNumber: pageNumber
        };
        previewImage.src = imageData;
        previewModal.classList.remove('hidden');
    }

    function downloadImage(imageData, filename) {
        try {
            // 增强类型检查
            if (typeof imageData !== 'string') {
                // 如果是对象，尝试获取data属性
                if (imageData && typeof imageData.data === 'string') {
                    imageData = imageData.data;
                } else {
                    throw new Error('无效的图片数据格式');
                }
            }

            // 检查数据前缀
            if (!imageData.startsWith('data:image/')) {
                // 如果不是dataURL，尝试转换
                if (imageData instanceof Blob) {
                    return downloadBlob(imageData, filename);
                }
                throw new Error('图片数据必须是dataURL或Blob');
            }

            // 创建下载链接
            const link = document.createElement('a');
            link.href = imageData;
            link.download = filename;

            // 添加到DOM并触发点击
            document.body.appendChild(link);
            link.click();

            // 延迟清理
            setTimeout(() => {
                document.body.removeChild(link);
                if (link.href.startsWith('blob:')) {
                    URL.revokeObjectURL(link.href);
                }
            }, 100);
        } catch (error) {
            console.error('下载失败:', error);
            alert(`下载失败: ${error.message}`);
        }
    }

    // 新增的Blob下载函数
    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 100);
    }

    // 下载所有页面
    function downloadAllPages() {
        if (allImages.length === 0) return;

        // 对于少量页面可以直接逐个下载
        if (allImages.length <= 10) {
            allImages.forEach(img => {
                setTimeout(() => {
                    downloadImage(img.data, `page-${img.pageNumber}.jpg`);
                }, 300 * (img.pageNumber - 1)); // 错开下载时间，避免浏览器限制
            });
        } else {
            // 对于大量页面，提示用户
            alert(`将下载 ${allImages.length} 个图片文件，可能需要一些时间`);
            allImages.forEach(img => {
                setTimeout(() => {
                    downloadImage(img.data, `page-${img.pageNumber}.jpg`);
                }, 500 * (img.pageNumber - 1));
            });
        }
    }

    // 清除所有内容
    function clearAll() {
        pdfDoc = null;
        totalPages = 0;
        currentPage = 1;
        allImages = [];
        thumbnailsContainer.innerHTML = '';
        pdfInfo.classList.add('hidden');
        pagination.classList.add('hidden');
        previewModal.classList.add('hidden');
        dropArea.classList.remove('hidden');
        fileInput.value = '';
    }
</script>
</body>
</html>
